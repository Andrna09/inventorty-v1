<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
  <h3 class="fw-bold text-primary">Barang Masuk</h3>
</div>

<div class="card border-0 shadow-sm p-4 mb-4 fade-in" style="border-radius: 12px;">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label text-muted">Tanggal</label>
      <input type="date" id="bm_tgl" class="form-control">
    </div>
    <div class="col-md-5">
      <label class="form-label text-muted">Kode Barang</label>
      <div class="input-group">
        <input type="text" id="bm_kode" class="form-control" placeholder="Scan atau Ketik Kode...">
        <button class="btn btn-outline-primary" onclick="bm_startScan()"><i class="material-icons">qr_code_scanner</i></button>
      </div>
    </div>
    <div class="col-md-4 d-grid">
      <button class="btn btn-info text-white" onclick="bm_cekBarang()" style="margin-top: 30px;">
        <i class="material-icons" style="font-size:16px; vertical-align:text-bottom;">search</i> Cek Barang
      </button>
    </div>
  </div>
  
  <div id="bm_info" class="row mt-3 p-3 bg-light rounded border mx-1" style="display:none;">
    <div class="col-md-4"><strong>Nama:</strong> <span id="bm_nama" class="text-primary">-</span></div>
    <div class="col-md-4"><strong>Stok:</strong> <span id="bm_stok" class="badge bg-secondary">-</span></div>
    <div class="col-md-4"><strong>Satuan:</strong> <span id="bm_satuan">-</span></div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-3">
      <label class="form-label text-muted">Jumlah Masuk</label>
      <input type="number" id="bm_jml" class="form-control" min="1">
    </div>
    <div class="col-md-4">
      <label class="form-label text-muted">Gudang Tujuan</label>
      <select id="bm_gudang" class="form-select">
        <option>Gudang 1</option>
        <option>Gudang 2</option>
        <option>Gudang 3</option>
      </select>
    </div>
    <div class="col-md-5 d-flex align-items-end">
      <button class="btn btn-primary w-100 fw-bold" onclick="bm_simpan()">
        <i class="material-icons" style="font-size:18px; vertical-align:bottom;">save</i> SIMPAN
      </button>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm p-4 fade-in" style="border-radius: 12px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Riwayat Masuk</h5>
    <div class="input-group w-auto">
      <input type="text" id="bm_search" class="form-control form-control-sm" placeholder="Cari..." onkeyup="bm_loadData()">
    </div>
  </div>
  
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Jml</th><th>Gudang</th><th>Aksi</th></tr>
      </thead>
      <tbody id="bm_table"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
    </table>
  </div>
  
  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-sm btn-outline-secondary" onclick="bm_nav(-1)">Prev</button>
    <span id="bm_page_info" class="align-self-center text-muted small">Page 1</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="bm_nav(1)">Next</button>
  </div>
</div>

<div class="modal fade" id="bm_scanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Scanner</h5>
        <button type="button" class="btn-close btn-close-white" onclick="bm_stopScan()"></button>
      </div>
      <div class="modal-body p-0 bg-dark">
        <div id="bm_reader" style="width:100%"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // Gunakan 'var' agar tidak error saat reload halaman SPA
  var bm_page = 1;
  var bm_scanner = null;

  // Init Function (Pengganti DOMContentLoaded)
  (function() {
    document.getElementById('bm_tgl').valueAsDate = new Date();
    bm_loadData();
  })();

  function bm_cekBarang() {
    var kode = document.getElementById('bm_kode').value;
    if(!kode) return Swal.fire('Info', 'Masukkan kode barang', 'info');
    
    google.script.run.withSuccessHandler(function(p) {
      if(p) {
        document.getElementById('bm_nama').innerText = p.nama;
        document.getElementById('bm_stok').innerText = p.stok;
        document.getElementById('bm_satuan').innerText = p.satuan;
        document.getElementById('bm_info').style.display = 'flex';
      } else {
        Swal.fire('Oops', 'Barang tidak ditemukan', 'error');
        document.getElementById('bm_info').style.display = 'none';
      }
    }).getProdukByBarcode(kode);
  }

  function bm_simpan() {
    var data = {
      tgl: document.getElementById('bm_tgl').value,
      kode: document.getElementById('bm_kode').value,
      jml: document.getElementById('bm_jml').value,
      gudang: document.getElementById('bm_gudang').value
    };

    if(!data.kode || !data.jml) return Swal.fire('Error', 'Lengkapi data!', 'warning');

    Swal.showLoading();
    google.script.run.withSuccessHandler(function(res) {
      Swal.close();
      if(res.success) {
        Swal.fire('Sukses', res.message, 'success');
        document.getElementById('bm_kode').value = '';
        document.getElementById('bm_jml').value = '';
        document.getElementById('bm_info').style.display = 'none';
        bm_loadData();
      } else {
        Swal.fire('Gagal', res.message, 'error');
      }
    }).addBarangMasuk(data.tgl, data.kode, data.jml, data.gudang);
  }

  function bm_loadData() {
    var search = document.getElementById('bm_search').value;
    google.script.run.withSuccessHandler(function(res) {
      var html = '';
      if(res.data.length === 0) html = '<tr><td colspan="6" class="text-center text-muted">Data kosong</td></tr>';
      else {
        res.data.forEach(function(r) {
          html += `<tr>
            <td>${r[0]}</td><td><span class="badge bg-light text-dark border">${r[1]}</span></td>
            <td>${r[2]}</td><td><strong>${r[5]}</strong> ${r[4]}</td><td>${r[6]}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="bm_hapus(${r[7]})"><i class="material-icons" style="font-size:16px">delete</i></button></td>
          </tr>`;
        });
      }
      document.getElementById('bm_table').innerHTML = html;
      document.getElementById('bm_page_info').innerText = 'Page ' + res.currentPage;
    }).getDataBarangMasuk('', bm_page, 10, search);
  }

  function bm_hapus(idx) {
    Swal.fire({title:'Hapus Data?', text:'Stok akan dikurangi otomatis', icon:'warning', showCancelButton:true}).then((result) => {
      if(result.isConfirmed) {
        Swal.showLoading();
        google.script.run.withSuccessHandler(function(res) {
          Swal.fire('Info', res, 'info');
          bm_loadData();
        }).hapusBarangMasuk(idx);
      }
    });
  }

  function bm_nav(dir) {
    if(dir === -1 && bm_page > 1) { bm_page--; bm_loadData(); }
    if(dir === 1) { bm_page++; bm_loadData(); }
  }

  // --- LOGIC SCANNER ---
  function bm_startScan() {
    var modal = new bootstrap.Modal(document.getElementById('bm_scanModal'));
    modal.show();
    if(!bm_scanner) bm_scanner = new Html5Qrcode("bm_reader");
    bm_scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
      function(decoded) {
        document.getElementById('bm_kode').value = decoded;
        bm_stopScan();
        bm_cekBarang();
        // Play Beep
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator();
        osc.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.1);
      }
    );
  }
  
  function bm_stopScan() {
    if(bm_scanner) bm_scanner.stop().then(() => bm_scanner.clear());
    var el = document.getElementById('bm_scanModal');
    var modal = bootstrap.Modal.getInstance(el);
    if(modal) modal.hide();
  }
</script>
